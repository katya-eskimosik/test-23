name: Python CI with Telegram Notifications

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  test-and-notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -e .

      - name: Run tests and process output
        id: pytest
        run: |
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–≤–æ–¥
          pytest --verbose > pytest_output.log 2>&1
          TEST_STATUS=$?
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
          echo "status=$TEST_STATUS" >> $GITHUB_OUTPUT
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π –æ—Ç—á–µ—Ç
          FAILED_TESTS=$(grep -E 'FAILED|ERROR' pytest_output.log || echo "No failed tests")
          SUMMARY=$(grep -E 'passed|FAILED|ERROR' pytest_output.log | tail -n 1)
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo "=== –ö—Ä–∞—Ç–∫–∏–π –æ—Ç—á–µ—Ç ===" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "=== –û—à–∏–±–∫–∏ ===" >> $GITHUB_OUTPUT
          echo "$FAILED_TESTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å —Ç–µ—Å—Ç–æ–≤
          exit $TEST_STATUS

      - name: Send Telegram notification
        uses: appleboy/telegram-action@v1.0.0
        with:
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          message: |
            ${{ fromJSON('{"0":"‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!","1":"‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏ –≤ —Ç–µ—Å—Ç–∞—Ö!"}')[steps.pytest.outputs.status] }}
            
            üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
            ${{ steps.pytest.outputs.results }}
            
            üîó –ü–æ–¥—Ä–æ–±–Ω–µ–µ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        if: always()
