name: Python CI with Telegram Notifications

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  test-and-notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -e .

      - name: Run tests and process output
        id: pytest
        continue-on-error: true
        run: |
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
          TEMP_OUTPUT=$(mktemp)
          TEMP_REPORT=$(mktemp)
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–≤–æ–¥
          pytest --verbose > "$TEMP_OUTPUT" 2>&1 || true
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
          TEST_STATUS=$?
          echo "status=$TEST_STATUS" >> $GITHUB_OUTPUT
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
          {
            echo "=== Test Results Summary ==="
            grep -E 'FAILED|ERROR|passed' "$TEMP_OUTPUT" | tail -n 1
            echo ""
            echo "=== Failed Tests ==="
            grep -A 3 -E 'FAILED|ERROR' "$TEMP_OUTPUT" || echo "No failed tests"
          } > "$TEMP_REPORT"
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á–µ—Ç
          echo "report<<EOF" >> $GITHUB_OUTPUT
          cat "$TEMP_REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # –î–ª—è –æ—Ç–ª–∞–¥–∫–∏: –≤—ã–≤–æ–¥–∏–º –æ—Ç—á–µ—Ç –≤ –ª–æ–≥
          echo "Generated report:"
          cat "$TEMP_REPORT"

      - name: Send Telegram notification
        uses: appleboy/telegram-action@v1.0.0
        with:
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          message: |
            ${{ fromJSON('{"0":"‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ","1":"‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏ –≤ —Ç–µ—Å—Ç–∞—Ö"}')[steps.pytest.outputs.status] }}
            
            üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
            ```
            ${{ steps.pytest.outputs.report }}
            ```
            
            üîó –ü–æ–¥—Ä–æ–±–Ω–µ–µ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        if: always()
        
